#!/usr/bin/env php
<?php

/**
 * CodeIgniter Command Line Interface
 *
 * THE BOOK OF YOUR DESTINY - Portable CLI Tool
 * Can be executed from anywhere to manage the application
 *
 * Usage: php spark [command] [options]
 */

// Determine root path dynamically
$rootPath = dirname(__DIR__) . DIRECTORY_SEPARATOR;

// Define paths
define('ROOTPATH', $rootPath);
define('FCPATH', $rootPath . 'public' . DIRECTORY_SEPARATOR);
define('APPPATH', ROOTPATH . 'app' . DIRECTORY_SEPARATOR);
define('SYSTEMPATH', ROOTPATH . 'vendor' . DIRECTORY_SEPARATOR . 'codeigniter4' . DIRECTORY_SEPARATOR . 'framework' . DIRECTORY_SEPARATOR);
define('WRITEPATH', ROOTPATH . 'writable' . DIRECTORY_SEPARATOR);

// Check PHP Version
$minPHPVersion = '8.0';
if (PHP_VERSION_ID < 80000) {
    fwrite(STDERR, "Your PHP version must be $minPHPVersion or higher to run CodeIgniter.\n");
    fwrite(STDERR, "Current version: " . PHP_VERSION . "\n");
    exit(1);
}

// Check if vendor directory exists
if (!is_dir(SYSTEMPATH)) {
    fwrite(STDERR, "CodeIgniter framework not found. Please run: composer install\n");
    exit(1);
}

// Load the environment file
$envPath = ROOTPATH . '.env';
if (!file_exists($envPath)) {
    $envPath = ROOTPATH . '.env.example';
}

if (file_exists($envPath)) {
    @include_once $envPath;
}

// Set the environment
if (!defined('ENVIRONMENT')) {
    define('ENVIRONMENT', getenv('CI_ENVIRONMENT') ?? 'production');
}

// Ensure the current directory is in the command execution path
chdir(FCPATH);

// Load the bootstrap file
require SYSTEMPATH . 'bootstrap.php';

// Load boot configuration
require APPPATH . 'Config/Boot/production.php';

// Run the CLI commands
try {
    $command = service('commands');
    $command->run(array_slice($_SERVER['argv'] ?? [], 1));
} catch (Throwable $e) {
    fwrite(STDERR, $e->getMessage() . "\n");
    exit(1);
}
